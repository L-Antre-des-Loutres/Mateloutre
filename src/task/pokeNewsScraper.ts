import otterlogs from "../utils/otterlogs";
import * as fs from "node:fs";
import path from "path";
import {fetchPokeNews} from "../scraper/pokeNewsScraper";
import {Client, TextChannel, EmbedBuilder, ColorResolvable} from "discord.js";

const CACHE_FILE = path.join(__dirname, '../../cache/pokekalos-latest-news.cache');

let client: Client;

export function pokeScrapinitialize(discordClient: Client) {
    client = discordClient;
    scrape().catch(err => {
        console.error("‚ùå Erreur initiale du scraping :", err);
    });
}

setInterval(async () => {
    await scrape();
}, 1000 * 60 * 15); // toutes les 30 minutes

// Fonction de scraping
async function scrape() {

    otterlogs.log(`Lancement du scraping des actus de Pokekalos.`);

    try {
        const lastTitle = fs.existsSync(CACHE_FILE) ? fs.readFileSync(CACHE_FILE, 'utf-8') : '';
        const news = await fetchPokeNews(lastTitle);

        if (!news.length) {
            otterlogs.log('‚úÖ Aucune nouvelle actu.');
            return;
        }

        const channel = client.channels.cache.get(process.env.NEWS_CHANNEL_ID) as TextChannel;

        // Envoi des articles du plus ancien au plus r√©cent
        for (const article of news.slice().reverse()) {
            const message = `üóíÔ∏è Une nouvelle actualit√© Pok√©mon est en ligne sur Pokekalos.`;

            const embed = new EmbedBuilder()
                .setTitle(article.title)
                .setURL(article.link)
                .setDescription(`${article.description}\nüîó [Lire l'article](${article.link})`)
                .setImage(article.image)
                .setColor(process.env.BOT_COLOR as ColorResolvable)
                .setFields(
                    { name: 'Source', value: 'Pokekalos', inline: true },
                    { name: 'Date', value: article.date, inline: true }
                )
                .setFooter({
                    text: "Mineotter",
                    iconURL: client.user?.displayAvatarURL() || '',
                })
                .setTimestamp();

            await channel.send({ content: message, embeds: [embed] });

            otterlogs.log(`‚úÖ Nouvelle actu envoy√©e : ${article.title}`);
        }

        // ‚ö†Ô∏è On ne met √† jour le cache qu'apr√®s avoir tout envoy√©
        fs.writeFileSync(CACHE_FILE, news[0].title); // Le plus r√©cent est news[0]
    } catch (error) {
        console.error("Erreur lors du scraping :", error);
    }
}